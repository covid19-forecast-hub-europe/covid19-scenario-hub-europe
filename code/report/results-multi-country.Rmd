---
title: European COVID-19 Scenario Modelling Hub
output:
  html_document:
    self_contained: false
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
params:
  round: 1
---

```{r setup, include = FALSE}
# Settings
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, 
                      message = FALSE, warning = FALSE)
knitr::knit_hooks$set(fig.width = knitr::hook_pngquant)
```

```{r prep}
library(here)
source(here("code", "report", "prep.R"))
```

# Round `r params$round`
_Report created `r Sys.Date()`_

### Current situation

- vaccination

### Scenarios

We asked teams of researchers across Europe to use quantitative models to project COVID-19 outcomes for 32 European countries over the next year. In order to explore different sets of assumptions about drivers of the pandemic, we asked teams to vary four sets of parameters. We can describe this in a 2x2 scenario specification:

```{r table-scenario, results = 'asis'}
cat(scenarios[[round_text]][["table"]])
```

See also the [full scenario details](`r paste0("https://github.com/covid19-forecast-hub-europe/covid19-scenario-hub-europe/wiki/Round-", params$round)`) for more detail on the common set of assumptions teams used to create their models.

In Round `r params$round`, we asked modellers to start their projections from the `r scenarios[[round_text]][["origin_date"]]`. Data after this date were not included, and as a result, model projections are unlikely to fully account for later information on the changing variants or behavioural patterns.

### Participating teams

```{r models}
models_summary <- results %>%
  group_by(model) %>%
  summarise(Countries = n_distinct(location),
            Weeks = max(as.numeric(gsub(" wk", "", horizon))))

models_summary %>%
  select(Team = model, Countries, Weeks) %>%
  arrange(desc(Weeks)) %>%
  arrange(desc(Countries)) %>%
  knitr::kable(caption = "Participating teams by number of countries and horizon")
```

# Multi-model summary {.tabset}

### Cumulative outcomes {.tabset .tabset-pills}

For each model and scenario, we compare the total number of outcomes over the entire projection period as a % of the total country population.

```{r plot-cumulative, results = 'asis'}
source(here("code", "summarise", "cumulative.R"))
cumulative_plots <- plot_cumulative_summary(data = results_multi_country,
                                            truth = truth)
for (target in scenarios$targets) {
  target <- gsub("^inc ", "", target)
  cat('\n')
  cat(paste0('#### ', tools::toTitleCase(target)))
  cat('\n')
  print(cumulative_plots[[target]])
  cat('\n')
}
```

### Incident outcomes {.tabset .tabset-pills}

```{r plot-projections, results = 'asis'}
for (target in scenarios$targets) {
  cat('\n')
  cat(paste0('#### ', tools::toTitleCase(gsub("^inc ", "", target))))
  cat('\n')
  print(
    plot_scenarios(
      results_multi_country, 
      truth,
      round = params$round,
      target_variable = target,
      columns = "scenario",
      model_colours = palette$models,
      scenario_colours = palette$scenarios,
      subsample = 0.2, per_100k = TRUE
    )
  )
  cat('\n')
}
```

# Peaks {.tabset}

```{r detect-peaks}
source(here("code", "summarise", "peaks.R"))
peaks <- detect_peaks(results_multi_country)
```

### Size and timing of highest peak {.tabset .tabset-pills}

```{r plot-peaks-size, results = 'asis'}
peaks_size_plots <- plot_peak_size(peaks = peaks, truth = truth)
for (target in scenarios$targets) {
  cat('\n')
  cat(paste0('#### ', tools::toTitleCase(gsub("^inc ", "", target))))
  cat('\n')
  print(peaks_size_plots[[target]])
  cat('\n')
}
```

### Number of peaks {.tabset .tabset-pills}

```{r plot-peaks-n, results = 'asis'}
peaks_n_plots <- plot_peaks_number(peaks = peaks)
for (target in scenarios$targets) {
  cat('\n')
  cat(paste0('#### ', tools::toTitleCase(gsub("^inc ", "", target))))
  cat('\n')
  print(peaks_n_plots[[target]])
  cat('\n')
}
```

