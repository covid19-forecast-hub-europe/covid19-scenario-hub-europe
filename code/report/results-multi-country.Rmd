---
title: European COVID-19 Scenario Modelling Hub
output:
  html_document:
    self_contained: false
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
params:
  round: 1
---

```{r setup, include = FALSE}
# Settings
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, 
                      message = FALSE, warning = FALSE)
knitr::knit_hooks$set(fig.width = knitr::hook_pngquant)
```

```{r prep}
library(here)
source(here("code", "report", "prep.R"))
```

# Round `r params$round`
_Report created `r Sys.Date()`_

### Current situation

- vaccination

### Scenarios

We asked teams of researchers across Europe to use quantitative models to project COVID-19 outcomes for 32 European countries over the next year. In order to explore different sets of assumptions about drivers of the pandemic, we asked teams to vary four sets of parameters. We can describe this in a 2x2 scenario specification:

```{r table-scenario, results = 'asis'}
cat(scenarios[[round_text]][["table"]])
```

See also the [full scenario details](`r paste0("https://github.com/covid19-forecast-hub-europe/covid19-scenario-hub-europe/wiki/Round-", params$round)`) for more detail on the common set of assumptions teams used to create their models.

In Round `r params$round`, we asked modellers to start their projections from the `r scenarios[[round_text]][["origin_date"]]`. Data after this date were not included, and as a result, model projections are unlikely to fully account for later information on the changing variants or behavioural patterns.

### Participating teams

```{r models}
models_summary <- results %>%
  group_by(model) %>%
  summarise(Countries = n_distinct(location),
            Weeks = max(as.numeric(gsub(" wk", "", horizon))))

models_summary %>%
  select(Team = model, Countries, Weeks) %>%
  arrange(desc(Weeks)) %>%
  arrange(desc(Countries)) %>%
  knitr::kable(caption = "Participating teams by number of countries and horizon")
```

# Multi-model summary {.tabset}

No country had results from more than two models. Given the low coverage, we did not produce an ensemble model.

The cumulative number of projected outcomes compared to the cumulative total over one year before projections started (May 2021 - May 2022). While there was very low or no probability of deaths over the next year matching the previous year's total, 

Looking at countries and targets with more than one model, we observed higher total counts of projected outcomes when immunity was modelled as weaker (a faster decline to a reduced plateau of immunity).


### Cumulative outcomes {.tabset .tabset-pills}

For each model and scenario, we compare the total number of outcomes over the entire projection period as a % of the total country population.

```{r plot-cumulative, results = 'asis'}
source(here("code", "summarise", "cumulative.R"))
cumulative_plots <- plot_cumulative_summary(data = results_multi_country,
                                            truth = truth,
                                            compare_last_year = TRUE)
for (target in scenarios$targets) {
  target <- gsub("^inc ", "", target)
  cat('\n')
  cat(paste0('#### ', tools::toTitleCase(target)))
  cat('\n')
  print(cumulative_plots[[target]])
  cat('\n')
  cat('\n')
  cat(scenarios[["round-1"]][["scenario_caption"]])
  cat('\n')
}
```

### Incident outcomes {.tabset .tabset-pills}

```{r plot-projections, results = 'asis'}
for (target in scenarios$targets) {
  cat('\n')
  cat(paste0('#### ', tools::toTitleCase(gsub("^inc ", "", target))))
  cat('\n')
  print(
    plot_scenarios(
      results_multi_country, 
      truth,
      round = params$round,
      target_variable = target,
      columns = "scenario",
      model_colours = palette$models,
      scenario_colours = palette$scenarios,
      subsample = 0.2, per_100k = TRUE
    )
  )
  cat('\n')
}
```

# Peaks {.tabset}

```{r detect-peaks}
source(here("code", "summarise", "peaks.R"))
autumn_winter_months <- c(9,10,11,12,1,2)
peaks <- detect_peaks(results_multi_country)
peaks_aw <- peaks |>
  filter(month(target_end_date) %in% autumn_winter_months)
```
### Total number of peaks {.tabset}

We summarised the number of peaks projected by each model and show the median (with 5-95% probability) number of peaks over a given period (September to February, or the entire year's projection).

#### Over autumn-winter {.tabset .tabset-pills}

Peaks over September to February (inclusive).

```{r plot-peaks-n-aw, results = 'asis'}
peaks_n_plots_aw <- plot_peaks_number(peaks = peaks_aw)
for (target in scenarios$targets) {
  cat('\n')
  cat(paste0('##### ', tools::toTitleCase(gsub("^inc ", "", target))))
  cat('\n')
  print(peaks_n_plots_aw[[target]])
  cat('\n')
  cat('\n')
  cat(scenarios[["round-1"]][["scenario_caption"]])
  cat('\n')
}
```

#### Over the entire projection period {.tabset .tabset-pills}

```{r plot-peaks-n-alltime, results = 'asis'}
peaks_n_plots <- plot_peaks_number(peaks = peaks)
for (target in scenarios$targets) {
  cat('\n')
  cat(paste0('##### ', tools::toTitleCase(gsub("^inc ", "", target))))
  cat('\n')
  print(peaks_n_plots[[target]])
  cat('\n')
  cat('\n')
  cat(scenarios[["round-1"]][["scenario_caption"]])
  cat('\n')
}
```

### Peaks over autumn-winter {.tabset .tabset-pills}

We show the timing and value of maximum weekly incidence over September to February.

Dots indicate the highest weekly incidence in each sample of each model, while violin shapes indicate the distribution within each model.
 
```{r plot-peaks-size-aw, results = 'asis'}
peaks_size_plots_aw <- plot_peak_aw(peaks = peaks_aw)
for (target in scenarios$targets) {
  cat('\n')
  cat(paste0('###### ', tools::toTitleCase(gsub("^inc ", "", target))))
  cat('\n')
  print(peaks_size_plots_aw[[target]])
  cat('\n')
  cat('\n')
  cat(scenarios[["round-1"]][["scenario_caption"]])
  cat('\n')
}
```







