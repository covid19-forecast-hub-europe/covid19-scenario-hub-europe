---
title: European COVID-19 Scenario Modelling Hub
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
params:
  round: 1
---

```{r set-up, include=FALSE}
# Packages
library(here)
library(dplyr)
library(ggplot2)
library(purrr)
source(here("code", "load", "scenarios.R"))
source(here("code", "load", "load_local_results.R"))
# Settings
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, 
                      message = FALSE, warning = FALSE,
                      eval.after = "fig.cap")
# Get results
results <- load_local_results(round = params$round)
round_text <- paste0("round-", params$round)
target_dirs <- gsub("inc ", "", scenarios$targets)
names(target_dirs) <- gsub("Weekly ", "", names(target_dirs))
names(target_dirs) <- tools::toTitleCase(names(target_dirs))
```

# Round `r params$round`

_Report created `r Sys.Date()`_

- Reporting projections originating `r scenarios[[round_text]][["origin_date"]]`

- See [full scenario details](`r paste0("https://github.com/covid19-forecast-hub-europe/covid19-scenario-hub-europe/wiki/Round-", params$round)`)

### Model availability

```{r models}
models_summary <- results %>%
  group_by(model) %>%
  summarise(Locations = n_distinct(location),
            scenarios = n_distinct(scenario_id),
            variables = n_distinct(target_variable),
            max_date = max(target_end_date),
            Weeks = max(as.numeric(gsub(" wk", "", horizon))))

models_summary %>%
  select(Model = model, Locations, Weeks) %>%
  arrange(desc(Weeks)) %>%
  arrange(desc(Locations)) %>%
  knitr::kable(caption = "Available model results")
```


### Comparative projections {.tabset}

Results show model projections across 4 scenarios and 32 locations.

#### By scenario {.tabset .tabset-pills}

```{r plot-scenario-comparison, results = 'asis'}
for (target in target_dirs){
  cat("\n")
  cat("##### ", names(target_dirs[target_dirs==target])) 
  cat("\n",
      "![](", here("reports", round_text, target, "cross-scenario.png)"),
      "\n")
}
```

#### By model {.tabset .tabset-pills}

```{r plot-model-comparison, results = 'asis'}
for (target in target_dirs){
  cat("\n")
  cat("##### ", names(target_dirs[target_dirs==target]))
  cat("\n", 
      "![](", here("reports", round_text, target, "cross-model.png)"),
      "\n")
}
```


### Individual model projections {.tabset}

```{r plot-individual-models, results = 'asis'}
for (model in unique(results$model)){
  cat("\n", "\n")
  cat("#### ", model, " {.tabset .tabset-pills}")
  cat("\n")
  
  for (target in target_dirs){
    model_target_plot <- here("reports", round_text, target, "models", 
                              paste0(model, ".png"))
    
    if (file.exists(model_target_plot)) {
      cat("\n")
      cat("##### ", names(target_dirs[target_dirs==target])) 
      cat("\n")
      cat("![](", model_target_plot, ")")
      cat("\n")
    }
  }
}
```
