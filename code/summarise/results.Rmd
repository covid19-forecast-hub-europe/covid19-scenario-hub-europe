---
title: European COVID-19 Scenario Modelling Hub
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
params:
  round: 1
---

```{r set-up, include=FALSE}
# Packages
library(here)
library(dplyr)
library(ggplot2)
library(purrr)
source(here("code", "load", "scenarios.R"))
source(here("code", "load", "load_local_results.R"))
# Settings
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, 
                      message = FALSE, warning = FALSE,
                      eval.after = "fig.cap")
# Get results
results <- load_local_results(round = params$round)
round_text <- paste0("round-", params$round)
target_dirs <- gsub("inc ", "", scenarios$targets)
names(target_dirs) <- gsub("Weekly ", "", names(target_dirs))
names(target_dirs) <- tools::toTitleCase(names(target_dirs))
```

# Round `r params$round`
_Report created `r Sys.Date()`_

### Scenarios

We asked teams of researchers across Europe to use quantitative models to project COVID-19 outcomes for 32 European countries over the next year. In order to explore different sets of assumptions about drivers of the pandemic, we asked teams to vary four sets of parameters. We can describe this in a 2x2 scenario specification:

```{r table-scenario, results = 'asis'}
cat(scenarios[[round_text]][["table"]])
```

See also the [full scenario details](`r paste0("https://github.com/covid19-forecast-hub-europe/covid19-scenario-hub-europe/wiki/Round-", params$round)`) for more detail on the common set of assumptions teams used to create their models.

In Round `r params$round`, we asked modellers to start their projections from the `r scenarios[[round_text]][["origin_date"]]`. Data after this date were not included, and as a result, model projections are unlikely to fully account for later information on the changing variants or behavioural patterns.

### Participating teams

```{r models}
models_summary <- results %>%
  group_by(model) %>%
  summarise(Countries = n_distinct(location),
            scenarios = n_distinct(scenario_id),
            variables = n_distinct(target_variable),
            max_date = max(target_end_date),
            Weeks = max(as.numeric(gsub(" wk", "", horizon))))

models_summary %>%
  select(Team = model, Countries, Weeks) %>%
  arrange(desc(Weeks)) %>%
  arrange(desc(Countries)) %>%
  knitr::kable(caption = "Participating teams by number of countries and horizon")
```

### Comparative projections {.tabset}

#### By scenario {.tabset .tabset-pills}

```{r plot-scenario-comparison, results = 'asis'}
for (target in target_dirs){
  cat("\n")
  cat("##### ", names(target_dirs[target_dirs==target])) 
  cat("\n",
      "![](", here("reports", round_text, target, "cross-scenario.png)"),
      "\n")
}
```

#### By model {.tabset .tabset-pills}

```{r plot-model-comparison, results = 'asis'}
for (target in target_dirs){
  cat("\n")
  cat("##### ", names(target_dirs[target_dirs==target]))
  cat("\n", 
      "![](", here("reports", round_text, target, "cross-model.png)"),
      "\n")
}
```


### Individual model projections {.tabset}

```{r plot-individual-models, results = 'asis'}
for (model in unique(results$model)){
  cat("\n", "\n")
  cat("#### ", model, " {.tabset .tabset-pills}")
  cat("\n")
  
  for (target in target_dirs){
    model_target_plot <- here("reports", round_text, target, "models", 
                              paste0(model, ".png"))
    
    if (file.exists(model_target_plot)) {
      cat("\n")
      cat("##### ", names(target_dirs[target_dirs==target])) 
      cat("\n")
      cat("![](", model_target_plot, ")")
      cat("\n")
    }
  }
}
```
