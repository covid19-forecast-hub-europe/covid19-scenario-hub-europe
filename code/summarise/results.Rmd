---
title: European COVID-19 Scenario Modelling Hub
output:
  html_document:
    self_contained: false
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
params:
  round: 1
---

```{r setup, include = FALSE}
# Settings
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, 
                      message = FALSE, warning = FALSE)
knitr::knit_hooks$set(fig.width = knitr::hook_pngquant)
```

```{r prep}
# Packages
library(here)
library(dplyr)
library(ggplot2)
library(purrr)
library(covidHubUtils)
source(here("code", "load", "scenarios.R"))
source(here("code", "load", "load_local_results.R"))
source(here("code", "load", "plot_scenarios.R"))
source(here("code", "load", "plot_palettes.R"))

# Get results
results <- load_local_results(round = params$round)

# create consistent model and scenario colour palettes
palette <- plot_palettes(results,
                         scenario_reds = c("A", "C"),
                         scenario_blues = c("B", "D"))

round_text <- paste0("round-", params$round)
target_dirs <- gsub("inc ", "", scenarios$targets)
names(target_dirs) <- gsub("Weekly ", "", names(target_dirs))
names(target_dirs) <- tools::toTitleCase(names(target_dirs))

truth <- load_truth(
  truth_source = "JHU",
  temporal_resolution = "weekly",
  hub = "ECDC"
) |>
  select(-model)
```

# Round `r params$round`
_Report created `r Sys.Date()`_

### Scenarios

We asked teams of researchers across Europe to use quantitative models to project COVID-19 outcomes for 32 European countries over the next year. In order to explore different sets of assumptions about drivers of the pandemic, we asked teams to vary four sets of parameters. We can describe this in a 2x2 scenario specification:

```{r table-scenario, results = 'asis'}
cat(scenarios[[round_text]][["table"]])
```

See also the [full scenario details](`r paste0("https://github.com/covid19-forecast-hub-europe/covid19-scenario-hub-europe/wiki/Round-", params$round)`) for more detail on the common set of assumptions teams used to create their models.

In Round `r params$round`, we asked modellers to start their projections from the `r scenarios[[round_text]][["origin_date"]]`. Data after this date were not included, and as a result, model projections are unlikely to fully account for later information on the changing variants or behavioural patterns.

### Participating teams

```{r models}
models_summary <- results %>%
  group_by(model) %>%
  summarise(Countries = n_distinct(location),
            scenarios = n_distinct(scenario_id),
            variables = n_distinct(target_variable),
            max_date = max(target_end_date),
            Weeks = max(as.numeric(gsub(" wk", "", horizon))))

models_summary %>%
  select(Team = model, Countries, Weeks) %>%
  arrange(desc(Weeks)) %>%
  arrange(desc(Countries)) %>%
  knitr::kable(caption = "Participating teams by number of countries and horizon")
```

### Comparative projections {.tabset}

```{r short-scenario-description, results = 'asis'}
cat(paste0("Scenarios include: ",
           scenarios[[round_text]][["scenario_caption"]]))
```

#### By scenario {.tabset .tabset-pills}

```{r plot-scenario-comparison, results = 'asis', fig.width = 8, fig.height = length(unique(results$location)) * 0.75}
for (target in scenarios$targets) {
  cat("\n")
  cat("##### ", tools::toTitleCase(gsub("^inc ", "", target)), "\n")
  print(
    plot_scenarios(
      results, truth,
      round = params$round,
      target_variable = target,
      columns = "scenario",
      model_colours = palette$models,
      scenario_colours = palette$scenarios
    )
  )
  cat("\n")
}
```

#### By model {.tabset .tabset-pills}

```{r plot-model-comparison, results = 'asis', fig.width = 8, fig.height = length(unique(results$location)) * 0.75}
for (target in scenarios$targets) {
  cat("\n")
  cat("##### ", tools::toTitleCase(gsub("^inc ", "", target)), "\n")
  print(
    plot_scenarios(
      results, truth,
      round = params$round,
      target_variable = target,
      columns = "model",
      model_colours = palette$models,
      scenario_colours = palette$scenarios
    ) 
  )
  cat("\n")
}
```

### Individual model projections {.tabset}

```{r plot-individual-models, results = 'asis', fig.width = 8, fig.height = length(unique(results$location)) * 0.75}
for (model in unique(results$model)) {
  cat("\n\n")
  cat("#### ", model, " {.tabset .tabset-pills}")

  
  res_model <- results |> 
    filter(model == .env$model)
  
  for (target in unique(res_model$target_variable)) {
    cat("\n")
    cat("##### ", tools::toTitleCase(gsub("^inc ", "", target)), "\n")
    
    print(
      res_model |> 
        filter(target_variable == .env$target) |> 
        plot_scenarios(
          truth = truth,
          target_variable = target,
          columns = "model",
          model_colours = palette$models,
          scenario_colours = palette$scenarios
        )
    )

    cat("\n")
  }
}
```
